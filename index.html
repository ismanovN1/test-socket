<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body>
    <h2>WebSocket Test</h2>
    <span>Token:</span>
    <input type="text" id="token">
    <span>Company ID:</span>
    <input type="text" id="companyId">
    <button onclick="connect()">Connect</button>
    <br>
    <br>
    <button onclick="sendMessage()">Send</button>
    <input type="text" id="inputMsg">
    <div id="output"></div>

    <script>
        let stompClient = null;
        let accessToken
        let companyId

        function connect() {
            accessToken = document.getElementById('token').value
            companyId = document.getElementById('companyId').value
            console.log('token', token);
            console.log('cID', companyId);

            if (!accessToken || !companyId) {
                alert(!accessToken ? 'enter token' : 'enter company ID')
                return
            }


            const socket = new SockJS("https://api.dev.novio-eld.com/core/eld-websocket");
            stompClient = Stomp.over(socket);

            stompClient.connect({
                    "access_token": accessToken
                },
                function (frame) {
                    console.log("Connected: " + frame);
                    stompClient.subscribe("/core/topic/notification/" + companyId, function (message) {
                        console.log("Get message :", message)
                        const received = JSON.parse(message.body);
                        console.log("Received :", received)
                        document.getElementById("output").innerText +=
                            `\nðŸ“© ${received.title}: ${received.description}`;
                    });
                },
                function (error) {
                    alert('Connection error', JSON.stringify(error))
                    console.error("Connection error:", error);
                }
            );
        }

        function sendMessage() {
            const msg = document.getElementById("inputMsg").value;
            const payload = {
                companyId: companyId,
                title: "Test title",
                description: msg
            };
            stompClient.send("/core/app/send", {}, JSON.stringify(payload));
        }
    </script>
</body>

</html>
